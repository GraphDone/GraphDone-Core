FROM node:18-alpine

WORKDIR /app

# Install global dependencies
RUN npm install -g nodemon tsx turbo

# Copy root package files
COPY package.json package-lock.json turbo.json tsconfig.json ./

# Copy all package.json files to maintain workspace structure
COPY packages/core/package.json packages/core/
COPY packages/server/package.json packages/server/
COPY packages/web/package.json packages/web/
COPY packages/mcp-server/package.json packages/mcp-server/

# Install all dependencies
RUN npm ci

# Copy source code
COPY packages/ packages/

# Build core package first (dependency for server)
RUN cd packages/core && npm run build

EXPOSE 4127

# Development command
CMD ["npm", "run", "dev", "--workspace=@graphdone/server"]